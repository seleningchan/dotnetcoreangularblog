/*!
 * FilePondPluginImageTransform 3.2.4
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://pqina.nl/filepond/ for details.
 */

/* eslint-disable */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).FilePondPluginImageTransform=e()}(this,function(){"use strict";var t=function(t,e){return{x:t,y:e}},e=function(e,n){return t(e.x-n.x,e.y-n.y)},n=function(t,n){return Math.sqrt(function(t,n){return function(t,e){return t.x*e.x+t.y*e.y}(e(t,n),e(t,n))}(t,n))},i=function(e,n){var i=e,a=n,r=1.5707963267948966-n,o=Math.sin(1.5707963267948966),u=Math.sin(a),c=Math.sin(r),h=Math.cos(r),l=i/o;return t(h*(l*u),h*(l*c))},a=function(e,a){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{x:.5,y:.5},u=o.x>.5?1-o.x:o.x,c=o.y>.5?1-o.y:o.y,h=2*u*e.width,l=2*c*e.height,f=function(e,a){var r=e.width,o=e.height,u=i(r,a),c=i(o,a),h=t(e.x+Math.abs(u.x),e.y-Math.abs(u.y)),l=t(e.x+e.width+Math.abs(c.y),e.y+Math.abs(c.x)),f=t(e.x-Math.abs(c.y),e.y+e.height-Math.abs(c.x));return{width:n(h,l),height:n(h,f)}}(a,r);return Math.max(f.width/h,f.height/l)},r=function(t,e){var n=t.width,i=n*e;return i>t.height&&(n=(i=t.height)/e),{x:.5*(t.width-n),y:.5*(t.height-i),width:n,height:i}},o={1:function(){return[1,0,0,1,0,0]},2:function(t){return[-1,0,0,1,t,0]},3:function(t,e){return[-1,0,0,-1,t,e]},4:function(t,e){return[1,0,0,-1,0,e]},5:function(){return[0,1,1,0,0,0]},6:function(t,e){return[0,1,-1,0,e,0]},7:function(t,e){return[0,-1,-1,0,e,t]},8:function(t){return[0,-1,1,0,0,t]}},u=function(t){return t&&(t.horizontal||t.vertical)},c=function(t,e,n){if(!e&&!u(n))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;var i=document.createElement("canvas"),a=t.naturalWidth,r=t.naturalHeight,c=e>=5&&e<=8;c?(i.width=r,i.height=a):(i.width=a,i.height=r);var h=i.getContext("2d");if(e&&h.transform.apply(h,function(t,e,n){return-1===n&&(n=1),o[n](t,e)}(a,r,e)),u(n)){var l=[1,0,0,1,0,0];(!c&&n.horizontal||c&n.vertical)&&(l[0]=-1,l[4]=a),(!c&&n.vertical||c&&n.horizontal)&&(l[3]=-1,l[5]=r),h.transform.apply(h,l)}return h.drawImage(t,0,0,a,r),i},h=function(t,e,n){n||(n={});var i=c(t,e,n.flip),o={width:i.width,height:i.height},u=document.createElement("canvas"),h=n.aspectRatio||o.height/o.width,l=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=t.height/t.width,a=e,r=1,o=i;o>a&&(r=(o=a)/i);var u=Math.max(1/r,a/o),c=t.width/(n*r*u),h=c*e;return{width:Math.round(c),height:Math.round(h)}}(o,h,n.zoom);u.width=l.width,u.height=l.height;var f={x:.5*u.width,y:.5*u.height},d=f.x-o.width*(n.center?n.center.x:.5),s=f.y-o.height*(n.center?n.center.y:.5),g={x:0,y:0,width:u.width,height:u.height,center:f},m=a(o,r(g,h),n.rotation,n.center),v=(n.zoom||1)*m,p=u.getContext("2d");return p.translate(f.x,f.y),p.rotate(n.rotation||0),p.scale(v,v),p.drawImage(i,d-f.x,s-f.y,o.width,o.height),p.getImageData(0,0,u.width,u.height)},l=function(){var t={resize:function(t,e){var n=e.mode,i=e.upscale,a=e.size,r=a.width,o=a.height;null===r?r=o:null===o&&(o=r);if("force"!==n){var u=r/t.width,c=o/t.height,h=1;if("cover"===n?h=Math.max(u,c):"contain"===n&&(h=Math.min(u,c)),h>1&&!1===i)return t;r=t.width*h,o=t.height*h}for(var l=t.width,f=t.height,d=Math.round(r),s=Math.round(o),g=t.data,m=new Uint8ClampedArray(d*s*4),v=l/d,p=f/s,w=Math.ceil(v/2),y=Math.ceil(p/2),T=0;T<s;T++)for(var M=0;M<d;M++){for(var x=4*(M+T*d),A=0,_=0,E=0,I=gx_g=gx_b=gx_a=0,R=(T+.5)*p,O=Math.floor(T*p);O<(T+1)*p;O++)for(var b=Math.abs(R-(O+.5))/y,F=(M+.5)*v,N=b*b,U=Math.floor(M*v);U<(M+1)*v;U++){var P=Math.abs(F-(U+.5))/w,G=Math.sqrt(N+P*P);G>=-1&&G<=1&&(A=2*G*G*G-3*G*G+1)>0&&(P=4*(U+O*l),gx_a+=A*g[P+3],E+=A,g[P+3]<255&&(A=A*g[P+3]/250),I+=A*g[P],gx_g+=A*g[P+1],gx_b+=A*g[P+2],_+=A)}m[x]=I/_,m[x+1]=gx_g/_,m[x+2]=gx_b/_,m[x+3]=gx_a/E}return{data:m,width:d,height:s}}},e=function(e,n){n(function(e,n){return e.forEach(function(e){var i=t[e.type];i&&(n=i(n,e.data))}),n}(e.transforms,e.imageData))};self.onmessage=function(t){e(t.data.message,function(e){self.postMessage({id:t.data.id,message:e},[e.data.buffer])})}},f=function(t,e,n){if(1165519206===t.getUint32(e+4,!1)){e+=4;var i=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,i);var a=t.getUint16(e,i);e+=2;for(var r=0;r<a;r++)if(274===t.getUint16(e+12*r,i))return t.setUint16(e+12*r+8,1,i),!0;return!1}},d=function(t){return new Promise(function(e,n){var i=new FileReader;i.onload=function(){return e(function(t){var e=new DataView(t);if(65496!==e.getUint16(0))return null;for(var n,i,a=2,r=!1;a<e.byteLength&&(n=e.getUint16(a,!1),i=e.getUint16(a+2,!1)+2,n>=65504&&n<=65519||65534===n)&&(r||(r=f(e,a)),!(a+i>e.byteLength));)a+=i;return t.slice(0,a)}(i.result)||null)},i.readAsArrayBuffer(t.slice(0,262144))})},s=function(t){var e=t.loadImage,n=t.createWorker,i=t.getFilenameWithoutExtension,a=t.getFileFromBlob,r=function(t,e,n){return new Promise(function(r,o){var u=function(e){var n,o,u,c,h,l=a(e,(n=t.name,h=e.type,o="image/jpeg"===h||"image/png"===h?h:"image/jpeg",u=i(n),c="image/jpeg"===o?"jpg":o.split("/")[1],"".concat(u,".").concat(c)));r(l)};(function(t,e){return new Promise(function(n,i){var a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").putImageData(t,0,0),a.toBlob(n,e.type,e.quality)})})(e,n).then(function(e){n.stripImageHead?u(e):d(t).then(function(t){null!==t&&(e=new Blob([t,e.slice(20)],{type:e.type})),u(e)})}).catch(function(t){console.error(t)})})};return function(t,i,a,o){return new Promise(function(u,c){var f=function(e){if(t.archived)return u(i);var c=(a.find(function(t){return"crop"===t.type})||{}).data,f=h(e,(t.getMetadata("exif")||{}).orientation||-1,c);if(!a.length)return r(i,f,o).then(u);var d=n(l);d.post({transforms:a,imageData:f},function(e){if(t.archived)return u(i);r(i,function(t){var e;try{e=new ImageData(t.width,t.height)}catch(n){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e}(e),o).then(u),d.terminate()},[f.data.buffer])},d=URL.createObjectURL(i);e(d).then(function(t){URL.revokeObjectURL(d),f(t)})})}};"undefined"!=typeof window&&void 0!==window.document&&(HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,n){var i=this;setTimeout(function(){for(var a=i.toDataURL(e,n).split(",")[1],r=atob(a),o=r.length,u=new Uint8Array(o);o--;)u[o]=r.charCodeAt(o);t(new Blob([u],{type:e||"image/png"}))})}}));var g=function(t){var e=t.addFilter,n=t.utils,i=n.Type,o=n.forin,u=n.loadImage,c=n.getFileFromBlob,h=n.getFilenameWithoutExtension,l=n.createWorker,f=n.createBlob,d=n.renameFile,g=n.isFile,m=["crop","resize"],v=s({loadImage:u,createWorker:l,getFileFromBlob:c,getFilenameWithoutExtension:h}),p=function(t){var e=t.createBlob,n=t.renameFile;return function(t,i,o){return new Promise(function(u,c){var h=(o.find(function(t){return"crop"===t.type})||{}).data;if(!h)return u(i);var l=new FileReader;l.onloadend=function(){if(t.archived)return u(i);var o=l.result,c=document.createElement("div");c.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",c.innerHTML=o;var f=c.querySelector("svg");document.body.appendChild(c);var d=f.getBBox();c.parentNode.removeChild(c);var s=c.querySelector("title"),g=f.getAttribute("viewBox")||"",m=f.getAttribute("width")||"",v=f.getAttribute("height")||"",p=parseFloat(m)||null,w=parseFloat(v)||null,y=(m.match(/[a-z]+/)||[])[0]||"",T=(v.match(/[a-z]+/)||[])[0]||"",M=g.split(" ").map(parseFloat),x=M.length?{x:M[0],y:M[1],width:M[2],height:M[3]}:d,A=null!=p?p:x.width,_=null!=w?w:x.height;f.style.overflow="visible",f.setAttribute("width",A),f.setAttribute("height",_);var E=h.aspectRatio||_/A,I=A,R=I*E,O=a({width:A,height:_},r({width:I,height:R},E),h.rotation,h.center),b=h.zoom*O,F=h.rotation*(180/Math.PI),N={x:.5*I,y:.5*R},U={x:N.x-A*h.center.x,y:N.y-_*h.center.y},P=["rotate(".concat(F," ").concat(N.x," ").concat(N.y,")"),"translate(".concat(N.x," ").concat(N.y,")"),"scale(".concat(b,")"),"translate(".concat(-N.x," ").concat(-N.y,")"),"translate(".concat(U.x," ").concat(U.y,")")],G=["scale(".concat(h.flip.horizontal?-1:1," ").concat(h.flip.vertical?-1:1,")"),"translate(".concat(h.flip.horizontal?-A:0," ").concat(h.flip.vertical?-_:0,")")],S='<?xml version="1.0" encoding="UTF-8"?>\n<svg width="'.concat(I).concat(y,'" height="').concat(R).concat(T,'" \nviewBox="0 0 ').concat(I," ").concat(R,'" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>').concat(s?s.textContent:i.name,'</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="').concat(P.join(" "),'">\n<g transform="').concat(G.join(" "),'">\n').concat(f.outerHTML,"\n</g>\n</g>\n</svg>");u(n(e(S,"image/svg+xml"),i.name))},l.readAsText(i)})}}({createBlob:f,renameFile:d});return e("SHOULD_PREPARE_OUTPUT",function(t,e){var n=e.query;e.item;return new Promise(function(t){t(!n("IS_ASYNC"))})}),e("PREPARE_OUTPUT",function(t,e){var n=e.query,i=e.item;return new Promise(function(e){if(!g(t)||!function(t){return/^image/.test(t.type)}(t)||!n("GET_ALLOW_IMAGE_TRANSFORM")||i.archived)return e(t);var a=[];n("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_ORIGINAL")&&a.push(function(){return new Promise(function(e){e({name:n("GET_IMAGE_TRANSFORM_VARIANTS_ORIGINAL_NAME"),file:t})})}),n("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_DEFAULT")&&a.push(function(t,e,i){return new Promise(function(a){t(e,i).then(function(t){return a({name:n("GET_IMAGE_TRANSFORM_VARIANTS_DEFAULT_NAME"),file:t})})})});var r=n("GET_IMAGE_TRANSFORM_VARIANTS")||{};o(r,function(t,e){var n,i=(n=e,function(t,e,i){return t(e,n?n(i):i)});a.push(function(e,n,a){return new Promise(function(r){i(e,n,a).then(function(e){return r({name:t,file:e})})})})});var u=n("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),c=n("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),h=null===u?null:u/100,l=n("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),f=n("GET_IMAGE_TRANSFORM_CLIENT_TRANSFORMS")||m;i.setMetadata("output",{quality:h,type:l,client:f},!0);var d=function(t,e){return new Promise(function(a,r){var u=[];o(e,function(t,e){f.includes(t)&&u.push({type:t,data:e})}),function(t){t.sort(function(t,e){var n=m.indexOf(t.type),i=m.indexOf(e.type);return n<i?-1:n>i?1:0})}(u);var h=e.output||{},l=h.type,d=h.quality;return 0!==u.length||null!==d&&(null===d||"optional"!==c)||null!==l&&l!==t.type?/svg/.test(t.type)&&null===l?p(i,t,u).then(a):void v(i,t,u,{type:l||t.type,quality:d,stripImageHead:n("GET_IMAGE_TRANSFORM_OUTPUT_STRIP_IMAGE_HEAD")}).then(a):a(t)})},s=a.map(function(e){return e(d,t,i.getMetadata())});Promise.all(s).then(function(t){e(1===t.length&&null===t[0].name?t[0].file:t)})})}),{options:{allowImageTransform:[!0,i.BOOLEAN],imageTransformOutputMimeType:[null,i.STRING],imageTransformOutputQuality:[null,i.INT],imageTransformOutputStripImageHead:[!0,i.BOOLEAN],imageTransformClientTransforms:[null,i.ARRAY],imageTransformOutputQualityMode:["always",i.STRING],imageTransformVariants:[null,i.OBJECT],imageTransformVariantsIncludeDefault:[!0,i.BOOLEAN],imageTransformVariantsDefaultName:[null,i.STRING],imageTransformVariantsIncludeOriginal:[!1,i.BOOLEAN],imageTransformVariantsOriginalName:["original_",i.STRING]}}};return"undefined"!=typeof window&&void 0!==window.document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:g})),g});
